<?php
/**
 * @file
 * Code for the Farm Log feature.
 */

include_once 'farm_log.features.inc';

/**
 * Implements hook_form_alter().
 */
function farm_log_form_alter(&$form, &$form_state, $form_id) {

  // If this is the farm_movement log form...
  if ($form_id == 'log_form' && $form['#bundle'] == 'farm_movement') {

    // If the "farm_asset" query parameter is set...
    $params = drupal_get_query_parameters();
    if (!empty($params['farm_asset'])) {

      // Verify that the farm_asset is valid.
      $asset = farm_asset_load($params['farm_asset']);
      if ($asset) {

        // Add the asset to the form.
        $form['farm_asset'] = array(
          '#type' => 'value',
          '#value' => $asset,
        );

        // Prepopulate the movement's asset reference field.
        $form['field_farm_asset'][LANGUAGE_NONE][0]['target_id']['#default_value'] = entity_label('farm_asset', $asset) . ' (' . $asset->id . ')';

        // Add our custom submit handler to redirect to the asset on submit.
        $form['actions']['submit']['#submit'][] = 'farm_log_log_form_submit';
      }
    }
  }
}

/**
 * Additional submit handler for log_form() for redirecting to assets.
 */
function farm_log_log_form_submit($form, &$form_state) {

  // If a farm asset is set in the form, redirect to it afterwards.
  if (!empty($form_state['values']['farm_asset'])) {
    $asset = $form_state['values']['farm_asset'];
    $log_uri = entity_uri('farm_asset', $asset);
    $form_state['redirect'] = $log_uri['path'];
  }
}